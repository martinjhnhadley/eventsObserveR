<!DOCTYPE html>
<meta charset="utf-8">

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://use.fontawesome.com/6124f35d24.js"></script>
<script src="inst/htmlwidgets/lib/events_observer.js"></script>

<!-- <link href="animate_events.css" rel="stylesheet" type="text/css" /> -->

<script>
// The following will be handled in R when this is an HTMLWidget

(function () {

var events = [];

var ignore_species = ["Humans with or without domestic animals", "Humans", "Domestic animals", ""];

var species           = [];
var stations          = [];
var station_positions = [];
var parseTime  = d3.timeParse("%d-%b-%y %H:%M:%S");
var formatTime = d3.timeFormat("%H:%M:%S %d %b %y");

d3.csv("../../WildCRUData/WildCRU.csv",
       function (row) {
       	   // this should be performed by R when an HTMLWidget
       	   var species_id = species.indexOf(row["Species"]);
       	   var station = row["Camera ID"].substring(0, row["Camera ID"].indexOf("_Camera"));
//        	   var station_id = stations.indexOf(station);
       	   var time = parseTime(row["Date"] + " " + row["Time"]);
       	   var describe = function (attribute) {
       	   	   if (row[attribute]) {
       	   	   	  return " " + attribute + ": " + row[attribute];
       	   	   }
       	   	   return "";
       	   };
       	   if (ignore_species.indexOf(row["Species"]) >= 0) {
       	   	   return;
       	   }
       	   if (species_id < 0) {
		       species_id = species.push(row["Species"])-1;
		   }
// 		   if (station_id < 0) {
// 		       station_id = stations.push(station)-1;
// 		   }
	       return {//place_id:      station_id,
	               station:       station, // for testing moving place_id functionality to events_observer
				   event_type_id: species_id,
				   time:          time,
				   radius:        5*Math.sqrt(row["No. Individuals"]),
				   title:         row["No. Individuals"] + " " + row["Species"] + " by " + row["Camera ID"] + " at " + formatTime(time) +
									  describe("No. males") +
									  describe("No. females") +
									  describe("No. unknown") +
									  describe("No. SA") +
									  describe("No. juv")};
       },
	   function(error, data) {
	   	   var animal_observations = [];
	   	   var legend = [];
	   	   var max_event_type_id = 0;
	   	   var width  = 600;
	       var height = 600;
	       var color = d3.scaleSequential(d3.interpolateRainbow);
	   	   if (error) throw error;
	       data.forEach(function(event) {
	       				    if (event) {
	       				    	// max_event_type_id used for event color and legends
							    if (event.event_type_id > max_event_type_id) {
								    max_event_type_id = event.event_type_id;
							    }
								animal_observations.push(event);
	       				    }
	                    });
	       animal_observations.forEach(function (d) {
	       	   d.color = color(d.event_type_id/max_event_type_id);
	       });
	       legend = d3.range(max_event_type_id).map(function (id) {
	       												return {color: color(id/max_event_type_id),
	       												        description: species[id]};
	       });
	       animate_events(animal_observations, {place_key:                "station",
	                                            view_width:               width, 
	                                            view_height:              height,
	                                            legend:                   legend,
	                                            legend_columns:              2,
	                                            width:                    1200,
	                                            height:                    900,
	                                            period:                     24*60*60,
	                                            previous_period_duration:   24*60*60,
	                                            periods_per_second:         24});
	   });

}());

</script>
